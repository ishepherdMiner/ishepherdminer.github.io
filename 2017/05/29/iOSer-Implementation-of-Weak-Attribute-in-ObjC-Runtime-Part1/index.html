<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å‰è¨€ã€€ OC ä¸­çš„ weak å±æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¸ºä»€ä¹ˆåœ¨å¯¹è±¡é‡Šæ”¾åä¼šè‡ªåŠ¨å˜æˆ nilï¼Ÿæœ¬æ–‡å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†ä¸€ç‚¹æ¢è®¨ã€‚ ç¯å¢ƒã€€  mac OS Sierra 10.12.4objc709  å‚è€ƒç­”æ¡ˆã€€ æœç´¢åå‘ç°runtime å¦‚ä½•å®ç° weak å±æ€§ç»™å‡ºäº†ä¸€ä¸ªå‚è€ƒç­”æ¡ˆã€‚  runtime å¯¹æ³¨å†Œçš„ç±»ï¼Œ ä¼šè¿›è¡Œå¸ƒå±€ï¼Œå¯¹äº weak å¯¹è±¡ä¼šæ”¾å…¥ä¸€ä¸ª hash è¡¨ä¸­ã€‚ ç”¨ weak æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€ä½œ">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS - ObjC Runtime ä¸­ Weak å±æ€§çš„å®ç° (ä¸Š)">
<meta property="og:url" content="http://yoursite.com/2017/05/29/iOSer-Implementation-of-Weak-Attribute-in-ObjC-Runtime-Part1/index.html">
<meta property="og:site_name" content="ğŸ‘¨ğŸ»â€ğŸ’»&#39;s åšå®¢">
<meta property="og:description" content="å‰è¨€ã€€ OC ä¸­çš„ weak å±æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¸ºä»€ä¹ˆåœ¨å¯¹è±¡é‡Šæ”¾åä¼šè‡ªåŠ¨å˜æˆ nilï¼Ÿæœ¬æ–‡å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†ä¸€ç‚¹æ¢è®¨ã€‚ ç¯å¢ƒã€€  mac OS Sierra 10.12.4objc709  å‚è€ƒç­”æ¡ˆã€€ æœç´¢åå‘ç°runtime å¦‚ä½•å®ç° weak å±æ€§ç»™å‡ºäº†ä¸€ä¸ªå‚è€ƒç­”æ¡ˆã€‚  runtime å¯¹æ³¨å†Œçš„ç±»ï¼Œ ä¼šè¿›è¡Œå¸ƒå±€ï¼Œå¯¹äº weak å¯¹è±¡ä¼šæ”¾å…¥ä¸€ä¸ª hash è¡¨ä¸­ã€‚ ç”¨ weak æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€ä½œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9410efbb.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf94014011.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9412e326.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9439ecc9.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9417add1.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf940c681b.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9425970f.jpg">
<meta property="article:published_time" content="2017-05-29T10:34:18.000Z">
<meta property="article:modified_time" content="2025-04-26T14:35:08.499Z">
<meta property="article:author" content="å¿˜å·ä¸‰">
<meta property="article:tag" content="Runtime">
<meta property="article:tag" content="Mechanism">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ooo.0o0.ooo/2017/05/29/592bf9410efbb.jpg">

<link rel="canonical" href="http://yoursite.com/2017/05/29/iOSer-Implementation-of-Weak-Attribute-in-ObjC-Runtime-Part1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iOS - ObjC Runtime ä¸­ Weak å±æ€§çš„å®ç° (ä¸Š) | ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æ…¢å“äººé—´çƒŸç«è‰²ï¼Œé—²è§‚ä¸‡äº‹å²æœˆé•¿</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/29/iOSer-Implementation-of-Weak-Attribute-in-ObjC-Runtime-Part1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å¿˜å·ä¸‰">
      <meta itemprop="description" content="404~ ~ ~å°±å¤šèµ°ä¸€æ­¥">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS - ObjC Runtime ä¸­ Weak å±æ€§çš„å®ç° (ä¸Š)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-05-29 18:34:18" itemprop="dateCreated datePublished" datetime="2017-05-29T18:34:18+08:00">2017-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-26 22:35:08" itemprop="dateModified" datetime="2025-04-26T22:35:08+08:00">2025-04-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ã€€</p>
<p><code>OC</code> ä¸­çš„ <code>weak</code> å±æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¸ºä»€ä¹ˆåœ¨å¯¹è±¡é‡Šæ”¾åä¼šè‡ªåŠ¨å˜æˆ <em>nil</em>ï¼Ÿæœ¬æ–‡å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†ä¸€ç‚¹æ¢è®¨ã€‚</p>
<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>ã€€</p>
<blockquote>
<p>mac OS Sierra 10.12.4<br>objc709</p>
</blockquote>
<h2 id="å‚è€ƒç­”æ¡ˆ"><a href="#å‚è€ƒç­”æ¡ˆ" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a>å‚è€ƒç­”æ¡ˆ</h2><p>ã€€</p>
<p>æœç´¢åå‘ç°<a target="_blank" rel="noopener" href="https://dayon.gitbooks.io/-ios/content/chapter8.html">runtime å¦‚ä½•å®ç° weak å±æ€§</a>ç»™å‡ºäº†ä¸€ä¸ªå‚è€ƒç­”æ¡ˆã€‚</p>
<blockquote>
<p><code>runtime</code> å¯¹æ³¨å†Œçš„ç±»ï¼Œ ä¼šè¿›è¡Œå¸ƒå±€ï¼Œå¯¹äº <code>weak</code> å¯¹è±¡ä¼šæ”¾å…¥ä¸€ä¸ª <code>hash</code> è¡¨ä¸­ã€‚ ç”¨ <code>weak</code> æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€ä½œä¸º <code>key</code>ï¼Œå½“æ­¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º <code>0</code> çš„æ—¶å€™ä¼š <code>dealloc</code>ï¼Œå‡å¦‚ <code>weak</code> æŒ‡å‘çš„å¯¹è±¡å†…å­˜åœ°å€æ˜¯ <code>a</code> ï¼Œé‚£ä¹ˆå°±ä¼šä»¥ <code>a</code> ä¸ºé”®ï¼Œ åœ¨è¿™ä¸ª <code>weak</code> è¡¨ä¸­æœç´¢ï¼Œæ‰¾åˆ°æ‰€æœ‰ä»¥ <code>a</code> ä¸ºé”®çš„ <code>weak</code> å¯¹è±¡ï¼Œä»è€Œè®¾ç½®ä¸º <code>nil</code> ã€‚</p>
</blockquote>
<span id="more"></span>

<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>ã€€</p>
<h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WeakProperty</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">weak</span>) <span class="built_in">NSObject</span> *obj;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WeakProperty</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        WeakProperty *property = [[WeakProperty alloc] init];</span><br><span class="line">        <span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">        property.obj = obj;     </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,property.obj);   </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¼šè§¦å‘å‡½æ•° ``id objc_initWeak(id *location, id newObj)``       </span></span><br><span class="line">        <span class="comment">// NSObject *obj = [[NSObject alloc] init];</span></span><br><span class="line">        <span class="comment">// __weak NSObject *obj2 = obj;</span></span><br><span class="line">        <span class="comment">// ä¼šè§¦å‘å‡½æ•° ``void objc_copyWeak(id *dst, id *src)``</span></span><br><span class="line">        <span class="comment">// __weak NSObject *obj3 = obj2;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><p>ã€€</p>
<p>å¯¹è±¡çš„ <code>weak</code> å±æ€§è°ƒç”¨ <code>setter</code> æ—¶</p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf9410efbb.jpg"></p>
<ul>
<li>è°ƒç”¨ <code>id objc_storeWeak(id *location, id newObj)</code></li>
<li>è°ƒç”¨ <code>static id  storeWeak(id *location, objc_object *newObj)</code><br>â€¦</li>
</ul>
<p>ä½¿ç”¨ <code>NSLog</code> è¾“å‡º <code>property.obj</code> å±æ€§æ—¶</p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf94014011.jpg"></p>
<ul>
<li>è°ƒç”¨ <code>id objc_loadWeakRetained(id *location)</code> </li>
</ul>
<p>å½“ <code>dealloc</code> é‡Šæ”¾å¯¹è±¡æ—¶</p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf9412e326.jpg"></p>
<ul>
<li>è°ƒç”¨ <code>void objc_destroyWeak(id *location)</code></li>
</ul>
<h3 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h3><p>ã€€</p>
<p>æŸ¥çœ‹ <code>NSObject.mm</code> æºç å‘ç°</p>
<ul>
<li><code>id objc_storeWeak(id *location, id newObj)</code></li>
<li><code>id objc_storeWeakOrNil(id *location, id newObj)</code></li>
<li><code>id objc_initWeak(id *location, id newObj)</code></li>
<li><code>id objc_initWeakOrNil(id *location, id newObj)</code></li>
<li><code>void objc_destroyWeak(id *location)</code></li>
</ul>
<p>éƒ½è°ƒç”¨äº† <code>static id  storeWeak(id *location, objc_object *newObj)</code> , <code>objc_xxxWeakOrNil</code> å¤šäº†ä¸€ç‚¹é¢å¤–çš„å¤„ç†ï¼Œä½†å¹¶ä¸å½±å“æ•´ä½“çš„ç†è§£ã€‚è€Œ <code>void objc_destroyWeak(id *location)</code> åœ¨è°ƒç”¨ <code>static id  storeWeak(id *location, objc_object *newObj)</code> æ—¶ <code>newObj</code> å‚æ•°ä¼ é€’çš„æ˜¯ <code>nil</code> è¿™ä¸€ç‚¹ä¸ä¸Šé¢æåˆ°çš„å‚è€ƒç­”æ¡ˆä¸­å…³äº <code>dealloc</code> é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œå°†å“ˆå¸Œè¡¨ä¸­æŒ‡å®šçš„é”®å¯¹åº”çš„å€¼è®¾ç½®ä¸º <code>nil</code> æ˜¯ç¬¦åˆçš„ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>ã€€</p>
<ul>
<li><code>storeWeak</code> å‡½æ•°ç”¨äºä¸º <code>weak</code> å±æ€§èµ‹å€¼ (åŒ…æ‹¬é”€æ¯)</li>
<li><code>objc_loadWeakRetained</code> å‡½æ•°ç”¨äºè·å– <code>weak</code> å±æ€§</li>
</ul>
<h2 id="è§‚å¯Ÿ-amp-åˆ†æ"><a href="#è§‚å¯Ÿ-amp-åˆ†æ" class="headerlink" title="è§‚å¯Ÿ &amp; åˆ†æ"></a>è§‚å¯Ÿ &amp; åˆ†æ</h2><p>ã€€</p>
<p>å¯¹äºå‡½æ•° <code>storeWeak</code> ä¸»è¦åˆ†æä¸¤ç§æƒ…å†µä¸‹çš„è°ƒç”¨</p>
<ol>
<li>èµ‹å€¼ï¼Œå³ <code>id objc_storeWeak(id *location, id newObj)</code></li>
<li>é”€æ¯ï¼Œå³ <code>void objc_destroyWeak(id *location)</code></li>
</ol>
<p>è€Œå¯¹äº <code>weak</code> å±æ€§çš„è·å–ä¸»è¦åˆ†æ</p>
<ol>
<li>å‡½æ•° <code>id objc_loadWeakRetained(id *location)</code></li>
</ol>
<h3 id="è§‚å¯Ÿ-id-objc-storeWeak-id-location-id-newObj"><a href="#è§‚å¯Ÿ-id-objc-storeWeak-id-location-id-newObj" class="headerlink" title="è§‚å¯Ÿ: id objc_storeWeak(id *location, id newObj)"></a>è§‚å¯Ÿ: <code>id objc_storeWeak(id *location, id newObj)</code></h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * This function stores a new value into a __weak variable. It would</span></span><br><span class="line"><span class="comment"> * be used anywhere a __weak variable is the target of an assignment.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param location The address of the weak pointer itself</span></span><br><span class="line"><span class="comment"> * @param newObj The new object this weak ptr should now point to</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return \e newObj</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">id</span></span><br><span class="line">objc_storeWeak(<span class="type">id</span> *location, <span class="type">id</span> newObj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> storeWeak&lt;DoHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">        (location, (objc_object *)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°å•çº¯çš„è°ƒç”¨äº† <code>storeWeak</code> å‡½æ•°</p>
<h3 id="è§‚å¯Ÿ-void-objc-destroyWeak-id-location"><a href="#è§‚å¯Ÿ-void-objc-destroyWeak-id-location" class="headerlink" title="è§‚å¯Ÿ: void objc_destroyWeak(id *location)"></a>è§‚å¯Ÿ: <code>void objc_destroyWeak(id *location)</code></h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Destroys the relationship between a weak pointer</span></span><br><span class="line"><span class="comment"> * and the object it is referencing in the internal weak</span></span><br><span class="line"><span class="comment"> * table. If the weak pointer is not referencing anything, </span></span><br><span class="line"><span class="comment"> * there is no need to edit the weak table. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param location The weak pointer address. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">objc_destroyWeak(<span class="type">id</span> *location)</span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">void</span>)storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt;</span><br><span class="line">        (location, <span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¹Ÿåªæ˜¯å•çº¯çš„è°ƒç”¨äº† <code>storeWeak</code> å‡½æ•°</p>
<h3 id="å‡½æ•°-storeWeak-æºç "><a href="#å‡½æ•°-storeWeak-æºç " class="headerlink" title="å‡½æ•° storeWeak æºç "></a>å‡½æ•° <code>storeWeak</code> æºç </h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">template &lt;HaveOld haveOld, HaveNew haveNew,</span><br><span class="line">          CrashIfDeallocating crashIfDeallocating&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="type">id</span> </span><br><span class="line">storeWeak(<span class="type">id</span> *location, objc_object *newObj)</span><br><span class="line">&#123;</span><br><span class="line">    assert(haveOld  ||  haveNew);</span><br><span class="line">    <span class="keyword">if</span> (!haveNew) assert(newObj == <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    Class previouslyInitializedClass = <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">id</span> oldObj;</span><br><span class="line">    SideTable *oldTable;</span><br><span class="line">    SideTable *newTable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire locks for old and new values.</span></span><br><span class="line">    <span class="comment">// Order by lock address to prevent lock ordering problems. </span></span><br><span class="line">    <span class="comment">// Retry if the old value changes underneath us.</span></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        oldObj = *location;</span><br><span class="line">        oldTable = &amp;SideTables()[oldObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newTable = &amp;SideTables()[newObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newTable = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (haveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent a deadlock between the weak reference machinery</span></span><br><span class="line">    <span class="comment">// and the +initialize machinery by ensuring that no </span></span><br><span class="line">    <span class="comment">// weakly-referenced object has an un-+initialized isa.</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">        Class cls = newObj-&gt;getIsa();</span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;  </span><br><span class="line">            !((objc_class *)cls)-&gt;isInitialized()) </span><br><span class="line">        &#123;</span><br><span class="line">            SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">            _class_initialize(_class_getNonMetaClass(cls, (<span class="type">id</span>)newObj));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this class is finished with +initialize then we&#x27;re good.</span></span><br><span class="line">            <span class="comment">// If this class is still running +initialize on this thread </span></span><br><span class="line">            <span class="comment">// (i.e. +initialize called storeWeak on an instance of itself)</span></span><br><span class="line">            <span class="comment">// then we may proceed but it will appear initializing and </span></span><br><span class="line">            <span class="comment">// not yet initialized to the check above.</span></span><br><span class="line">            <span class="comment">// Instead set previouslyInitializedClass to recognize it on retry.</span></span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up old value, if any.</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assign new value, if any.</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newObj = (objc_object *)</span><br><span class="line">            weak_register_no_lock(&amp;newTable-&gt;weak_table, (<span class="type">id</span>)newObj, location, </span><br><span class="line">                                  crashIfDeallocating);</span><br><span class="line">        <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">            newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">        *location = (<span class="type">id</span>)newObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No new value. The storage is not changed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç»“åˆ <code>lldb</code> è¾¹è°ƒè¯•è¾¹å¯¹å…¶è¿›è¡Œåˆ†æï¼Œ</p>
<h3 id="åˆ†æ-id-objc-storeWeak-id-location-id-newObj"><a href="#åˆ†æ-id-objc-storeWeak-id-location-id-newObj" class="headerlink" title="åˆ†æ: id objc_storeWeak(id *location, id newObj)"></a>åˆ†æ: <code>id objc_storeWeak(id *location, id newObj)</code></h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Template parameters.</span></span><br><span class="line"><span class="keyword">enum</span> HaveOld &#123; DontHaveOld = <span class="literal">false</span>, DoHaveOld = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">enum</span> HaveNew &#123; DontHaveNew = <span class="literal">false</span>, DoHaveNew = <span class="literal">true</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ¨¡æ¿å‚æ•°ï¼Œä¼ é€’çš„æ˜¯ <code>DoHaveOld(true) &amp; DoHaveNew(true)</code></p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf9439ecc9.jpg"></p>
<p>åœ¨64ä½æ±‡ç¼–ä¸­ï¼Œå½“å‚æ•°å°‘äº7ä¸ªæ—¶ï¼Œ å‚æ•°ä»å·¦åˆ°å³æ”¾å…¥å¯„å­˜å™¨: <code>rdi, rsi, rdx, rcx, r8, r9</code>ã€‚æ­¤å¤„ <code>location</code> å’Œ <code>newObj</code> åˆ†åˆ«æ¥è‡ª <code>rdi</code>  å’Œ <code>rsi</code>ã€‚</p>
<p>æ ¹æ®æ³¨é‡ŠåŠ åœ°å€æ¯”è¾ƒï¼Œå¯çŸ¥ <code>location</code> ä¸º <strong>æŒ‡å‘å¼±å¼•ç”¨çš„åœ°å€</strong>ï¼Œ<code>newObj</code> ä¸ºè¦æ±‚ <strong>å¼±å¼•ç”¨æŒ‡å‘çš„åœ°å€</strong>ï¼Œåœ¨å½“å‰åœºæ™¯ä¸‹ä¸ºèµ‹å€¼ç»™ <code>WeakProperty</code> çš„ <code>obj</code> å±æ€§çš„ <code>obj</code> å˜é‡ã€‚</p>
<p>åœ¨å½“å‰åœºæ™¯ä¸‹å³ä¸ºæ‰§è¡Œ <code>storeWeak</code> åï¼Œå†…å­˜åœ°å€ <code>0x0000000101301638</code> ä¸Šä¿å­˜çš„å€¼ä¸º <code>0x0000000101301490</code></p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf9417add1.jpg"></p>
<h4 id="é“ºå«-SideTable"><a href="#é“ºå«-SideTable" class="headerlink" title="é“ºå«: SideTable"></a>é“ºå«: <code>SideTable</code></h4><p>ã€€</p>
<p>å…³äºç»“æ„ä½“ <code>SideTable</code>ï¼Œåœ¨æœ¬æ–‡ä¸­å½“åšé»‘ç›’æ¥å¤„ç†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> SideTable &#123;</span><br><span class="line">    spinlock_t slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    weak_table_t weak_table;</span><br><span class="line"></span><br><span class="line">    SideTable() &#123;</span><br><span class="line">        memset(&amp;weak_table, <span class="number">0</span>, <span class="keyword">sizeof</span>(weak_table));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~SideTable() &#123;</span><br><span class="line">        _objc_fatal(<span class="string">&quot;Do not delete SideTable.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> lock() &#123; slock.lock(); &#125;</span><br><span class="line">    <span class="type">void</span> unlock() &#123; slock.unlock(); &#125;</span><br><span class="line">    <span class="type">void</span> forceReset() &#123; slock.forceReset(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Address-ordered lock discipline for a pair of side tables.</span></span><br><span class="line"></span><br><span class="line">    template&lt;HaveOld, HaveNew&gt;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">void</span> lockTwo(SideTable *lock1, SideTable *lock2);</span><br><span class="line">    template&lt;HaveOld, HaveNew&gt;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">void</span> unlockTwo(SideTable *lock1, SideTable *lock2);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…³äº <code>spinlock_t</code>ï¼Œ<code>Wiki</code> ä¸Šå…³äº <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Spinlock"><code>Spinlock</code></a> è¯æ¡çš„è§£é‡Šå¦‚ä¸‹</p>
<blockquote>
<p>In software engineering, a spinlock is a lock which causes a thread trying to acquire it to simply wait in a loop (â€œspinâ€) while repeatedly checking if the lock is available. Since the thread remains active but is not performing a useful task, the use of such a lock is a kind of busy waiting. Once acquired, spinlocks will usually be held until they are explicitly released, although in some implementations they may be automatically released if the thread being waited on (that which holds the lock) blocks, or â€œgoes to sleep.</p>
</blockquote>
<p>ä¾‹å­</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Intel syntax</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">locked:</span>                      <span class="comment">; The lock variable. 1 = locked, 0 = unlocked.</span></span><br><span class="line">     <span class="built_in">dd</span>      <span class="number">0</span>               <span class="comment">; å®šä¹‰ lock å˜é‡ é»˜è®¤ä¸º 0 </span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">spin_lock:</span></span><br><span class="line">     <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">1</span>          <span class="comment">; Set the EAX register to 1. </span></span><br><span class="line">     									<span class="comment">; è®¾ç½® EAX å¯„å­˜å™¨çš„å€¼ä¸º 1 </span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">xchg</span>    <span class="built_in">eax</span>, [locked]   <span class="comment">; Atomically swap the EAX register with</span></span><br><span class="line">                             <span class="comment">;  the lock variable.</span></span><br><span class="line">                             <span class="comment">; This will always store 1 to the lock, leaving</span></span><br><span class="line">                             <span class="comment">;  the previous value in the EAX register.</span></span><br><span class="line">                             <span class="comment">; äº¤æ¢ eax ä¸ lock å˜é‡çš„å€¼ï¼Œæ ¹æ®ä¸Šä¸€æ­¥å¯çŸ¥ï¼Œlock è‚¯å®šä¼šè¢«èµ‹å€¼ä¸º1</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">test</span>    <span class="built_in">eax</span>, <span class="built_in">eax</span>        <span class="comment">; Test EAX with itself. Among other things, this will</span></span><br><span class="line">                             <span class="comment">;  set the processor&#x27;s Zero Flag if EAX is 0.</span></span><br><span class="line">                             <span class="comment">; If EAX is 0, then the lock was unlocked and</span></span><br><span class="line">                             <span class="comment">; we just locked it.</span></span><br><span class="line">                             <span class="comment">; Otherwise, EAX is 1 and we didn&#x27;t acquire the lock.</span></span><br><span class="line">										<span class="comment">; å°† EAX ä¸ è‡ªèº«æ¯”è¾ƒï¼Œå¦‚æœ EAX æ˜¯ 0 åˆ™è®¾ç½® Zeor Flag ï¼Œè¡¨æ˜å½“å‰æœªåŠ é”ï¼Œåªè¦åŠ é”æ“ä½œå³å¯ï¼Œåä¹‹è¯æ˜å·²è¢«åŠ é”ï¼Œä¸è®¾ç½® Zero Flagã€‚</span></span><br><span class="line">     <span class="keyword">jnz</span>     spin_lock       <span class="comment">; Jump back to the MOV instruction if the Zero Flag is</span></span><br><span class="line">                             <span class="comment">;  not set; the lock was previously locked, and so</span></span><br><span class="line">                             <span class="comment">; we need to spin until it becomes unlocked.</span></span><br><span class="line">										<span class="comment">; å¦‚æœ Zero Flag æœªè¢«è®¾ç½®ï¼Œåˆ™è·³è½¬ç»§ç»­ spin_lock</span></span><br><span class="line">     <span class="keyword">ret</span>                     <span class="comment">; The lock has been acquired, return to the calling</span></span><br><span class="line">                             <span class="comment">;  function.</span></span><br><span class="line">                             <span class="comment">; è·å¾—é”åï¼Œç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; å½“è·å¾—æ‰€çš„æ“ä½œæ‰§è¡Œå®Œæˆåï¼Œåˆ™ locked å˜æˆ 0ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†æ¬¡è¿›è¡Œ spin_lock æ“ä½œ locked ä¸º 0ï¼Œå¯¼è‡´ EAX ä¸º0 ï¼Œé‡æ–°è·å¾—äº†é”ï¼ŒåŒæ—¶ locked å˜æˆ 1...</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">spin_unlock:</span></span><br><span class="line">     <span class="keyword">mov</span>     <span class="built_in">eax</span>, <span class="number">0</span>          <span class="comment">; Set the EAX register to 0.</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">xchg</span>    <span class="built_in">eax</span>, [locked]   <span class="comment">; Atomically swap the EAX register with</span></span><br><span class="line">                             <span class="comment">;  the lock variable.</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">ret</span>                     <span class="comment">; The lock has been released.</span></span><br></pre></td></tr></table></figure>

<p>é…åˆ <code>google</code> çš„ç¿»è¯‘å¯çŸ¥ï¼Œè‡ªæ—‹é”ä¼šå¾ªç¯ç­‰å¾…ç›´åˆ°é”å¯ç”¨ã€‚</p>
<p>ä» <code>weak_table_t</code> ç»“æ„ä½“çš„æ³¨é‡Šè¯´æ˜äº†ï¼Œå®ƒä¼šä¿å­˜ <code>ids</code> å’Œ <code>keys</code> çš„å½¢å¼ä¿å­˜å¯¹è±¡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The global weak references table. Stores object ids as keys,</span></span><br><span class="line"><span class="comment"> * and weak_entry_t structs as their values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> weak_table_t &#123;</span><br><span class="line">    weak_entry_t *weak_entries;</span><br><span class="line">    size_t    num_entries;</span><br><span class="line">    uintptr_t mask;</span><br><span class="line">    uintptr_t max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç»“æ„ä½“ <code>SideTable</code> å¯çœ‹åšæ˜¯ä¸€ä¸ªå¸¦åŠ é”åŠŸèƒ½çš„é›†åˆï¼Œå…¶ä¸­çš„å…ƒç´ ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜æ”¾ã€‚</p>
<p>åœ¨ <code>ObjC</code> çš„å…¥å£å‡½æ•° <code>_objc_init</code> ä¼šè°ƒç”¨å‡½æ•° <code>arr_init</code> æ¥åˆå§‹åŒ– <code>SideTableBuf</code>   é™æ€å˜é‡</p>
<h4 id="æ­£æ–‡-id-objc-storeWeak-id-location-id-newObj"><a href="#æ­£æ–‡-id-objc-storeWeak-id-location-id-newObj" class="headerlink" title="æ­£æ–‡: id objc_storeWeak(id *location, id newObj)"></a>æ­£æ–‡: <code>id objc_storeWeak(id *location, id newObj)</code></h4><p>ã€€</p>
<p><strong>è¿›å…¥ <code>if (haveOld)</code> æ¡ä»¶</strong> </p>
<p>åˆ›å»ºæ–°å…ƒç´ ï¼Œå› æ­¤ <code>location</code> åœ°å€çš„åŸå€¼ä¸º <code>nil</code> </p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf940c681b.jpg"></p>
<p><strong>è¿›å…¥ SideTables() å‡½æ•°</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> StripedMap&lt;SideTable&gt;&amp; SideTables() &#123;</span><br><span class="line">    <span class="keyword">return</span> *reinterpret_cast&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/332030/when-should-static-cast-dynamic-cast-const-cast-and-reinterpret-cast-be-used">å…³äº <code>reinterpret_cast</code> çš„è®¨è®º</a></p>
<blockquote>
<p>reinterpret_cast is the most dangerous cast, and should be used very sparingly. It turns one type directly into another - such as casting the value from one pointer to another, or storing a pointer in an int, or all sorts of other nasty things. Largely, the only guarantee you get with reinterpret_cast is that normally if you cast the result back to the original type, you will get the exact same value (but not if the intermediate type is smaller than the original type). There are a number of conversions that reinterpret_cast cannot do, too. Itâ€™s used primarily for particularly weird conversions and bit manipulations, like turning a raw data stream into actual data, or storing data in the low bits of an aligned pointer.</p>
</blockquote>
<p>å®ƒæ˜¯ä¸€ç§ç±»å‹å¼ºè½¬çš„æ–¹å¼</p>
<p><img src="https://ooo.0o0.ooo/2017/05/29/592bf9425970f.jpg"></p>
<p><code>SideTableBuf</code> æ˜¯å¤§å°ä¸º <code>4096</code> çš„ <code>SideTable</code> ç¼“å­˜æ•°ç»„ï¼Œ <code>oldTable</code> çš„èµ‹å€¼ç›¸å½“äºåœ¨å–æ•°ç»„å…ƒç´ ï¼Œ<code>nil</code> å¯çœ‹æˆ <code>0</code> ï¼Œå³å–ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p>
<p>åŒç†ï¼Œ<code>haveNew</code> ä¸º <code>true</code> ï¼Œ<code>newTable</code> æ˜¯ä»¥ <code>newObj</code> ä¸ºç´¢å¼•åœ¨ <code>SideTabBuf</code> ä¸­ æŸ¥æ‰¾å…ƒç´ ã€‚</p>
<p><strong>è°ƒç”¨ SideTable::lockTwo æ–¹æ³•</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br></pre></td></tr></table></figure>

<p><strong>è¿›å…¥ SideTable::lockTwo æ–¹æ³•</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">template&lt;&gt;</span><br><span class="line"><span class="type">void</span> SideTable::lockTwo&lt;DoHaveOld, DoHaveNew&gt;</span><br><span class="line">    (SideTable *lock1, SideTable *lock2)</span><br><span class="line">&#123;</span><br><span class="line">    spinlock_t::lockTwo(&amp;lock1-&gt;slock, &amp;lock2-&gt;slock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿›å…¥ lockTwo æ–¹æ³•</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Address-ordered lock discipline for a pair of locks.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> lockTwo(mutex_tt *lock1, mutex_tt *lock2) &#123;</span><br><span class="line">   <span class="keyword">if</span> (lock1 &lt; lock2) &#123;</span><br><span class="line">       lock1-&gt;lock();</span><br><span class="line">       lock2-&gt;lock();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       lock2-&gt;lock();</span><br><span class="line">       <span class="keyword">if</span> (lock2 != lock1) lock1-&gt;lock(); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*<em>åˆ¤æ–­ if (haveOld  &amp;&amp;  <em>location != oldObj) æ¡ä»¶</em></em></p>
<p><code>haveOld  &amp;&amp;  *location != oldObj</code> ï¼Œ<code>oldObj</code> è¢«èµ‹å€¼ä¸º <code>*location</code> æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸¤è€…ç›¸ç­‰ï¼Œä¸ç­‰è¯´æ˜å‡ºäº†é—®é¢˜ï¼Œç®—æ˜¯å®¹é”™ã€‚</p>
<p><strong>åˆ¤æ–­ if (haveNew  &amp;&amp;  newObj) æ¡ä»¶</strong></p>
<p><code>haveNew  &amp;&amp;  newObj</code> æ ¹æ®æ³¨é‡Šå¯çŸ¥ä¹Ÿæ˜¯ä¸€ä¸ªå®¹é”™çš„å¤„ç†</p>
<p><strong>æ¸…é™¤æ—§å€¼</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">   weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>èµ‹äºˆæ–°å€¼</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assign new value, if any.</span></span><br><span class="line"><span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">   newObj = (objc_object *)</span><br><span class="line">       weak_register_no_lock(&amp;newTable-&gt;weak_table, (<span class="type">id</span>)newObj, location, </span><br><span class="line">                             crashIfDeallocating);</span><br><span class="line">   <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">   <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">       newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">   *location = (<span class="type">id</span>)newObj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// No new value. The storage is not changed.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ <em>location</em> ä¸º key,ä»¥ <em>newObj</em> ä¸ºå€¼ä¿å­˜åˆ°å¯¹åº”çš„ <code>weak_table_t</code> çš„ç»“æ„ä½“ä¸­</p>
<p><strong>è°ƒç”¨ SideTable::unlockTwo æ–¹æ³•</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br></pre></td></tr></table></figure>

<h3 id="åˆ†æ-void-objc-destroyWeak-id-location"><a href="#åˆ†æ-void-objc-destroyWeak-id-location" class="headerlink" title="åˆ†æ: void objc_destroyWeak(id *location)"></a>åˆ†æ: <code>void objc_destroyWeak(id *location)</code></h3><p>ã€€</p>
<p>å› ä¸ºä¼ é€’çš„æ¨¡æ¿å‚æ•°ä¸º <code>DontHaveNew</code> ï¼Œå½“é‡Šæ”¾æ‰æ—§å€¼åï¼Œä¸ä¼šå†è¿›å…¥ <code>if (haveNew)</code> æ¡ä»¶ä¸­è·å¾—æ–°å€¼ã€‚</p>
<h3 id="åˆ†æ-id-objc-loadWeakRetained-id-location"><a href="#åˆ†æ-id-objc-loadWeakRetained-id-location" class="headerlink" title="åˆ†æ: id objc_loadWeakRetained(id *location)"></a>åˆ†æ: <code>id objc_loadWeakRetained(id *location)</code></h3><p>ã€€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">retry:</span><br><span class="line">	<span class="comment">// fixme std::atomic this load</span></span><br><span class="line">	obj = *location;</span><br><span class="line">	...</span><br><span class="line">	result = obj;</span><br><span class="line">	... </span><br><span class="line">	<span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>*</code> å–å€¼ç¬¦å·æ“ä½œ <code>location</code> ï¼Œè·å¾—å¼±å¼•ç”¨æŒ‡å‘çš„åœ°å€ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ã€€</p>
<p>æœ¬æ–‡é€šè¿‡å¯¹ <code>ObjC</code> è¿è¡Œæ—¶ç²—ç•¥åˆ†æï¼Œæ¥äº†è§£ <code>weak</code> å±æ€§æ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨ï¼Œä½¿ç”¨ä¸é‡Šæ”¾çš„ã€‚<code>ObjC</code> çš„ç±»ç»“æ„ä¸­ä¸€ä¸ªé™æ€çš„é”®å€¼å¯¹è¡¨å˜é‡ï¼Œå®ƒä¿å­˜ç€å¯¹è±¡çš„å¼±å¼•ç”¨å±æ€§ï¼Œå…¶ä¸­çš„é”®ä¸ºæŒ‡å‘å¼±å¼•ç”¨çš„å†…å­˜åœ°å€ï¼Œå€¼ä¸ºå¼±å¼•ç”¨ï¼Œå½“å¯¹è±¡é”€æ¯æ—¶é€šè¿‡é”®æŸ¥è¡¨ï¼Œç„¶åå°†å¯¹åº”çš„å¼±å¼•ç”¨ä»è¡¨ä¸­ç§»é™¤ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>ã€€</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/332030/when-should-static-cast-dynamic-cast-const-cast-and-reinterpret-cast-be-used">When should static_cast, dynamic_cast, const_cast and reinterpret_cast be used?</a></li>
<li><a target="_blank" rel="noopener" href="https://lldb.llvm.org/lldb-gdb.html">The LLDB Debugger</a></li>
<li><a target="_blank" rel="noopener" href="http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/">64ä½æ±‡ç¼–å‚æ•°ä¼ é€’</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Spinlock">Wiki - Spinlock</a></li>
<li><a target="_blank" rel="noopener" href="http://en.cppreference.com/w/cpp/language/alignas">alignas specifier</a></li>
<li><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0204j/Cihcdbca.html">4.3.7. MOV and MVN</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Runtime/" rel="tag"># Runtime</a>
              <a href="/tags/Mechanism/" rel="tag"># Mechanism</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/05/20/iOS-Analysis-of-UIButton-s-imageEdgeInsets-with-titleEdgeInsets/" rel="prev" title="iOS - UIButtonçš„imageEdgeInsetsä¸titleEdgeInsets">
      <i class="fa fa-chevron-left"></i> iOS - UIButtonçš„imageEdgeInsetsä¸titleEdgeInsets
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/06/04/iOSer-Implementation-of-Weak-Attribute-in-ObjC-Runtime-Part2/" rel="next" title="ObjC Runtime ä¸­ Weak å±æ€§çš„å®ç° (ä¸­)">
      ObjC Runtime ä¸­ Weak å±æ€§çš„å®ç° (ä¸­) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">2.</span> <span class="nav-text">ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E7%AD%94%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">å‚è€ƒç­”æ¡ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">4.</span> <span class="nav-text">æµ‹è¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">4.1.</span> <span class="nav-text">ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C"><span class="nav-number">4.2.</span> <span class="nav-text">ç»“æœ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="nav-number">4.3.</span> <span class="nav-text">ç›¸å…³å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">4.4.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F-amp-%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">è§‚å¯Ÿ &amp; åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F-id-objc-storeWeak-id-location-id-newObj"><span class="nav-number">5.1.</span> <span class="nav-text">è§‚å¯Ÿ: id objc_storeWeak(id *location, id newObj)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F-void-objc-destroyWeak-id-location"><span class="nav-number">5.2.</span> <span class="nav-text">è§‚å¯Ÿ: void objc_destroyWeak(id *location)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-storeWeak-%E6%BA%90%E7%A0%81"><span class="nav-number">5.3.</span> <span class="nav-text">å‡½æ•° storeWeak æºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-id-objc-storeWeak-id-location-id-newObj"><span class="nav-number">5.4.</span> <span class="nav-text">åˆ†æ: id objc_storeWeak(id *location, id newObj)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BA%E5%9E%AB-SideTable"><span class="nav-number">5.4.1.</span> <span class="nav-text">é“ºå«: SideTable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E6%96%87-id-objc-storeWeak-id-location-id-newObj"><span class="nav-number">5.4.2.</span> <span class="nav-text">æ­£æ–‡: id objc_storeWeak(id *location, id newObj)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-void-objc-destroyWeak-id-location"><span class="nav-number">5.5.</span> <span class="nav-text">åˆ†æ: void objc_destroyWeak(id *location)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90-id-objc-loadWeakRetained-id-location"><span class="nav-number">5.6.</span> <span class="nav-text">åˆ†æ: id objc_loadWeakRetained(id *location)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">å¿˜å·ä¸‰</p>
  <div class="site-description" itemprop="description">404~ ~ ~å°±å¤šèµ°ä¸€æ­¥</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">85</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¿˜å·ä¸‰</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
