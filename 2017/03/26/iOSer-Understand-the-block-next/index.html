<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å‰è¨€æœ¬æ–‡å°†ä¼šä»å†…å­˜ç»“æ„ä¸Šåˆ†æ OC ä¸­çš„ Block ã€‚ ç¯å¢ƒ macOS Sierra 10.12.3Xcode 8.2.1  å…³äº Block çš„å®ç°åœ¨ Blockçš„å®ç° ä¸­çš„ Block çš„ç»“æ„å£°æ˜å¦‚ä¸‹">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS - ç†è§£Block(ä¸‹)">
<meta property="og:url" content="http://yoursite.com/2017/03/26/iOSer-Understand-the-block-next/index.html">
<meta property="og:site_name" content="ğŸ‘¨ğŸ»â€ğŸ’»&#39;s åšå®¢">
<meta property="og:description" content="å‰è¨€æœ¬æ–‡å°†ä¼šä»å†…å­˜ç»“æ„ä¸Šåˆ†æ OC ä¸­çš„ Block ã€‚ ç¯å¢ƒ macOS Sierra 10.12.3Xcode 8.2.1  å…³äº Block çš„å®ç°åœ¨ Blockçš„å®ç° ä¸­çš„ Block çš„ç»“æ„å£°æ˜å¦‚ä¸‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/03/26/58d713941b51b.jpg">
<meta property="og:image" content="https://ooo.0o0.ooo/2017/03/26/58d71395df78d.jpg">
<meta property="article:published_time" content="2017-03-26T01:02:56.000Z">
<meta property="article:modified_time" content="2025-04-26T14:05:14.528Z">
<meta property="article:author" content="å¿˜å·ä¸‰">
<meta property="article:tag" content="ObjC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ooo.0o0.ooo/2017/03/26/58d713941b51b.jpg">

<link rel="canonical" href="http://yoursite.com/2017/03/26/iOSer-Understand-the-block-next/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iOS - ç†è§£Block(ä¸‹) | ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">æ…¢å“äººé—´çƒŸç«è‰²ï¼Œé—²è§‚ä¸‡äº‹å²æœˆé•¿</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/26/iOSer-Understand-the-block-next/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="å¿˜å·ä¸‰">
      <meta itemprop="description" content="404~ ~ ~å°±å¤šèµ°ä¸€æ­¥">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸ‘¨ğŸ»â€ğŸ’»'s åšå®¢">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS - ç†è§£Block(ä¸‹)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2017-03-26 09:02:56" itemprop="dateCreated datePublished" datetime="2017-03-26T09:02:56+08:00">2017-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-04-26 22:05:14" itemprop="dateModified" datetime="2025-04-26T22:05:14+08:00">2025-04-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡å°†ä¼šä»å†…å­˜ç»“æ„ä¸Šåˆ†æ <code>OC</code> ä¸­çš„ <code>Block</code> ã€‚</p>
<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><blockquote>
<p>macOS Sierra 10.12.3<br>Xcode 8.2.1</p>
</blockquote>
<h2 id="å…³äº-Block-çš„å®ç°"><a href="#å…³äº-Block-çš„å®ç°" class="headerlink" title="å…³äº Block çš„å®ç°"></a>å…³äº <code>Block</code> çš„å®ç°</h2><p>åœ¨ <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/Block-ABI-Apple.html"><em>Blockçš„å®ç°</em></a> ä¸­çš„ <code>Block</code> çš„ç»“æ„å£°æ˜å¦‚ä¸‹</p>
<span id="more"></span>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Block_literal_1 &#123;</span><br><span class="line">    <span class="type">void</span> *isa; <span class="comment">// initialized to &amp;_NSConcreteStackBlock or &amp;_NSConcreteGlobalBlock</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">int</span> reserved;</span><br><span class="line">    <span class="type">void</span> (*invoke)(<span class="type">void</span> *, ...);</span><br><span class="line">    <span class="keyword">struct</span> Block_descriptor_1 &#123;</span><br><span class="line">    		<span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> reserved;         <span class="comment">// NULL</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> size;         <span class="comment">// sizeof(struct Block_literal_1)</span></span><br><span class="line">        <span class="comment">// optional helper functions</span></span><br><span class="line">        <span class="type">void</span> (*copy_helper)(<span class="type">void</span> *dst, <span class="type">void</span> *src);     <span class="comment">// IFF (1&lt;&lt;25)</span></span><br><span class="line">        <span class="type">void</span> (*dispose_helper)(<span class="type">void</span> *src);             <span class="comment">// IFF (1&lt;&lt;25)</span></span><br><span class="line">        <span class="comment">// required ABI.2010.3.16</span></span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *signature;                         <span class="comment">// IFF (1&lt;&lt;30)</span></span><br><span class="line">    &#125; *descriptor;</span><br><span class="line">    <span class="comment">// imported variables</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…³äº <code>ABI</code></p>
<blockquote>
<p>åœ¨è®¡ç®—æœºè½¯ä»¶ä¸­ï¼Œåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼ˆ<code>ABI</code>ï¼‰æ˜¯ä¸¤ä¸ªç¨‹åºæ¨¡å—ä¹‹é—´çš„æ¥å£ï¼Œå…¶ä¸­ä¸€ä¸ªç¨‹åºæ¨¡å—é€šå¸¸æ˜¯æœºå™¨ä»£ç çº§åˆ«çš„åº“æˆ–æ“ä½œç³»ç»Ÿã€‚ <code>ABI</code>ç¡®å®šå¦‚ä½•è°ƒç”¨å‡½æ•°ä»¥åŠåœ¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹å°†äºŒè¿›åˆ¶æ ¼å¼ä¿¡æ¯ä»ä¸€ä¸ªç¨‹åºç»„ä»¶ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªç¨‹åºç»„ä»¶æˆ–æ“ä½œç³»ç»Ÿçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
</blockquote>
<ol>
<li><code>Block</code> : ç»“æ„ä¸­æœ‰ä¸€ä¸ª <code>isa</code> æŒ‡é’ˆï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘ <code>_NSConcreteStackBlock</code> æˆ– <code>_NSConcreteGlobalBlock</code> çš„åœ°å€, ç”¨äºå®ç°å¯¹è±¡ç›¸å…³çš„åŠŸèƒ½ã€‚</li>
<li><code>flags</code> : ç”¨äºæŒ‰ <code>bit</code> ä½è¡¨ç¤ºä¸€äº› <code>block</code> çš„é™„åŠ ä¿¡æ¯</li>
<li><code>reserved</code> : ä¿ç•™ä½</li>
<li><code>void (*invoke)(void* ,...)</code> : æ¥æ”¶å¯å˜å‚æ•°çš„å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ <code>block</code> å®ç°çš„å‡½æ•°è°ƒç”¨ (<code>invoke</code>) åœ°å€ã€‚</li>
<li><code>descriptor</code> : <code>Block_descriptor_1</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¯¥ <code>block</code> çš„é™„åŠ æè¿°ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ <code>size</code> å¤§å°ï¼Œä»¥åŠ <code>copy</code> å’Œ <code>dispose</code> å‡½æ•°çš„æŒ‡é’ˆã€‚</li>
<li><code>imported variables</code> : <code>capture</code> è¿‡æ¥çš„å˜é‡ï¼Œ<code>block</code> èƒ½å¤Ÿè®¿é—®å®ƒå¤–éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œå°±æ˜¯å› ä¸ºå°†è¿™äº›å˜é‡ï¼ˆæˆ–å˜é‡çš„åœ°å€ï¼‰å¤åˆ¶åˆ°äº†ç»“æ„ä½“ä¸­ã€‚</li>
</ol>
<h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h3 id="å®è·µä¸€-æ–°å»º-Xcode-å‘½ä»¤è¡Œå·¥ç¨‹"><a href="#å®è·µä¸€-æ–°å»º-Xcode-å‘½ä»¤è¡Œå·¥ç¨‹" class="headerlink" title="å®è·µä¸€ : æ–°å»º Xcode å‘½ä»¤è¡Œå·¥ç¨‹"></a>å®è·µä¸€ : æ–°å»º <code>Xcode</code> å‘½ä»¤è¡Œå·¥ç¨‹</h3><p><code>main.m</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// insert code here...</span></span><br><span class="line">        <span class="type">void</span> (^blockDemo)() = ^() &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello world&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        blockDemo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æ–­ç‚¹ï¼Œç¼–è¯‘å¹¶è¿è¡Œï¼ŒæŒ‰æŒ‡ä»¤çº§åˆ«å•æ­¥è°ƒè¯•ï¼Œå¯å¾—åˆ°</p>
<p><img src="https://ooo.0o0.ooo/2017/03/26/58d713941b51b.jpg"></p>
<p>ä»ä¸Šé¢çš„ç»“æœå¯çŸ¥, <code>Block</code> ç»“æ„ç¡®å®å¦‚ä¸Šé¢æ‰€æè¿°çš„, <code>isa</code> æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ <code>__NSGlobalBlock__</code></p>
<p>å°†å·¥ç¨‹çš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åˆ° <code>Hopper</code> ï¼ŒæŸ¥çœ‹ <code>__main_block_invoke</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                     ___main_block_invoke:</span><br><span class="line"><span class="number">0000000100000</span>f10         push       rbp                                         ; Objective C Block defined at <span class="number">0x100001060</span>, XREF=<span class="number">0x100001070</span></span><br><span class="line"><span class="number">0000000100000</span>f11         mov        rbp, rsp</span><br><span class="line"><span class="number">0000000100000</span>f14         sub        rsp, <span class="number">0x10</span></span><br><span class="line"><span class="number">0000000100000</span>f18         lea        rax, qword [ds:cfstring_Hello_world]        ; <span class="string">@&quot;Hello world&quot;</span></span><br><span class="line"><span class="number">0000000100000</span>f1f         mov        qword [ss:rbp+var_8], rdi</span><br><span class="line"><span class="number">0000000100000</span>f23         mov        qword [ss:rbp+var_10], rdi</span><br><span class="line"><span class="number">0000000100000</span>f27         mov        rdi, rax                                    ; argument <span class="string">&quot;format&quot;</span> <span class="keyword">for</span> method imp___stubs__NSLog</span><br><span class="line"><span class="number">0000000100000</span>f2a         mov        al, <span class="number">0x0</span></span><br><span class="line"><span class="number">0000000100000</span>f2c         call       imp___stubs__NSLog</span><br><span class="line"><span class="number">0000000100000</span>f31         add        rsp, <span class="number">0x10</span></span><br><span class="line"><span class="number">0000000100000</span>f35         pop        rbp</span><br><span class="line"><span class="number">0000000100000</span>f36         ret        </span><br><span class="line">                        ; endp</span><br><span class="line"><span class="number">0000000100000</span>f37         db  <span class="number">0x90</span> ; <span class="string">&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure>

<p>åæ±‡ç¼–å¾—åˆ°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> ___main_block_invoke(<span class="type">void</span> * _block) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello world&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ <code>Xcode</code> å·¥ç¨‹ï¼Œç”¨ <code>Block</code> å»æ•è·å‚æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// insert code here...</span></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSString</span> *testString = <span class="string">@&quot;2&quot;</span>;</span><br><span class="line">        <span class="type">void</span> (^blockDemo)() = ^() &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello world,%d,%@&quot;</span>,a,testString);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        blockDemo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·æ“ä½œå¾—åˆ°å¦‚ä¸‹æˆªå›¾</p>
<p><img src="https://ooo.0o0.ooo/2017/03/26/58d71395df78d.jpg"></p>
<p>å¦‚æœå–æ¶ˆ <code>ARC</code> ç¯å¢ƒ, <code>isa</code> æŒ‡é’ˆä¼šæŒ‡å‘ <code>__NSStackBlock__</code>ï¼Œåœ¨æ­¤ä¸å†æˆªå›¾è¯´æ˜ã€‚</p>
<h3 id="å°ç»“ä¸€"><a href="#å°ç»“ä¸€" class="headerlink" title="å°ç»“ä¸€"></a>å°ç»“ä¸€</h3><ol>
<li>éªŒè¯äº† <code>Block</code> ä¸­ <code>invoke</code> å‡½æ•°æŒ‡é’ˆæŒ‡å‘ <code>block</code> å®ç°çš„å‡½æ•°åœ°å€ã€‚</li>
<li>éªŒè¯äº† <code>imported variables</code> ç¡®å®ä¿å­˜äº†ä»å¤–éƒ¨ <code>capture</code> åˆ° <code>Block</code> ä¸­çš„å˜é‡</li>
</ol>
<h3 id="é—®é¢˜ä¸€"><a href="#é—®é¢˜ä¸€" class="headerlink" title="é—®é¢˜ä¸€"></a>é—®é¢˜ä¸€</h3><p><code>Block</code> ä¸­ <code>isa</code> æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡å’Œ <code>Blockçš„å®ç°</code> æè¿°çš„æœ‰å‡ºå…¥</p>
<h3 id="å®è·µäºŒ-clang-é‡å†™å·¥ç¨‹çš„-main-m-æ–‡ä»¶"><a href="#å®è·µäºŒ-clang-é‡å†™å·¥ç¨‹çš„-main-m-æ–‡ä»¶" class="headerlink" title="å®è·µäºŒ : clang é‡å†™å·¥ç¨‹çš„ main.m æ–‡ä»¶"></a>å®è·µäºŒ : <code>clang</code> é‡å†™å·¥ç¨‹çš„ <code>main.m</code> æ–‡ä»¶</h3><p>æ‰¾åˆ° <code>main.m</code> æ–‡ä»¶ï¼Œåœ¨ç»ˆç«¯ä¸­ç”¨ <code>clang -rewrite-objc path/to/main.m</code> ç”Ÿæˆå¯¹åº”çš„ <code>C++</code> ä»£ç ã€‚</p>
<p>å‚è€ƒæœ¬æ–‡åçš„å¼•ç”¨é“¾æ¥ <em>3</em> æ‘˜å½•å‡ºä¸ <code>Block</code> ç›¸å…³çš„å®ç°éƒ¨åˆ†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BLOCK_IMPL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_IMPL</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="type">void</span> *isa;</span><br><span class="line">  <span class="type">int</span> Flags;</span><br><span class="line">  <span class="type">int</span> Reserved;</span><br><span class="line">  <span class="type">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Runtime copy/destroy helper functions (from Block_private.h)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __OBJC_EXPORT_BLOCKS</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">void</span> _Block_object_assign(<span class="type">void</span> *, <span class="keyword">const</span> <span class="type">void</span> *, <span class="keyword">const</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">void</span> _Block_object_dispose(<span class="keyword">const</span> <span class="type">void</span> *, <span class="keyword">const</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">void</span> *_NSConcreteGlobalBlock[<span class="number">32</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="type">void</span> *_NSConcreteStackBlock[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="type">void</span> _Block_object_assign(<span class="type">void</span> *, <span class="keyword">const</span> <span class="type">void</span> *, <span class="keyword">const</span> <span class="type">int</span>);</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="type">void</span> _Block_object_dispose(<span class="keyword">const</span> <span class="type">void</span> *, <span class="keyword">const</span> <span class="type">int</span>);</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="type">void</span> *_NSConcreteGlobalBlock[<span class="number">32</span>];</span><br><span class="line">__OBJC_RW_DLLIMPORT <span class="type">void</span> *_NSConcreteStackBlock[<span class="number">32</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __block</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __weak</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_8067ac_mi_0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="type">void</span> (*blockDemo)() = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line">        ((<span class="type">void</span> (*)(__block_impl *))((__block_impl *)blockDemo)-&gt;FuncPtr)((__block_impl *)blockDemo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> IMAGE_INFO &#123; <span class="type">unsigned</span> version; <span class="type">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>

<p><code>main</code> å‡½æ•°çš„æ‰§è¡Œæµç¨‹</p>
<ol>
<li>å‡½æ•° <code>__main_block_impl_0</code> ä»¥ <code>__main_block_func_0</code> ä¸ <code>__main_block_desc_0_DATA</code> ä½œå‚æ•°ä¼ å…¥æ¥å®Œæˆç»“æ„ä½“ <code>__main_block_impl_0</code> çš„åˆå§‹åŒ–</li>
<li>å‡½æ•° <code>__main_block_func_0</code> åœ¨è¿™é‡Œå³ä¸º <code>NSLog(@&quot;Hello world&quot;)</code>ï¼Œå°†å…¶åœ°å€ä¼ é€’ç»™ç»“æ„ä½“ <code>__main_block_impl_0</code> ä¸­çš„ <code>__block_impl</code> ç»“æ„ä½“ <code>impl</code> çš„å‡½æ•°æŒ‡é’ˆ <code>FuncPtr</code> </li>
<li>å‚æ•° <code>__main_block_desc_0</code> ä¼ é€’åˆ°ç»“æ„ä½“ <code>__main_block_impl_0</code> ä¸­çš„ <code>__main_block_desc_0</code> ç»“æ„ä½“çš„ <code>Desc</code></li>
<li><code>blockDemo</code> å‡½æ•°æŒ‡é’ˆå¼•ç”¨äº†å‰é¢ç»“æ„ä½“åˆå§‹åŒ–ä¸­è·å¾—çš„ <code>__main_block_impl_0</code> ç»“æ„ä½“</li>
<li><code>blockDemo</code> å‡½æ•°æŒ‡é’ˆå¼•ç”¨çš„ç»“æ„ä½“å¼ºè½¬ä¸º <code>__block_impl *</code> ç±»å‹ï¼Œå› ä¸ºç»“æ„ä½“ <code>__main_block_impl_0</code> çš„å†…å­˜ç»“æ„ä¸­æœ€å‰é¢å°±æ˜¯ <code>__block_impl</code> ç»“æ„ä½“çš„ <code>impl</code>ï¼Œå› æ­¤åœ¨è¿™é‡Œå¼ºè½¬ç±»å‹å€Ÿç”¨ä¸€ä¸‹é¢å‘å¯¹è±¡çš„æ¦‚å¿µå°±æ˜¯å­ç±»å¼ºè½¬æˆçˆ¶ç±»æŒ‡é’ˆï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å½“ç„¶é¢å‘è¿‡ç¨‹æ—©äºé¢å‘å¯¹è±¡ï¼Œé¢å‘å¯¹è±¡ä¸ºä»€ä¹ˆèƒ½å®ç°çˆ¶ç±»æŒ‡é’ˆå¼ºè½¬æˆå­ç±»ï¼Œåå€’æ˜¯åº”è¯¥è¦ä¾èµ–ä¸¤è€…å…¼å®¹çš„å†…å­˜ç»“æ„ã€‚</li>
<li>æ‰§è¡Œç¬¬ <em>5</em> æ­¥ç”Ÿæˆçš„ <code>__block_impl</code> çš„ç»“æ„ä½“çš„ <code>FuncPtr</code> å‡½æ•°ï¼Œå‰é¢éƒ¨åˆ†çš„ <code>((void (*)(__block_impl *))</code> è¡¨æ˜è¿™ä¸ªå‡½æ•°æ˜¯æ— è¿”å›å€¼,éœ€è¦ä¸€ä¸ª <code>__block_impl</code> çš„å‚æ•°ï¼Œåé¢éƒ¨åˆ†çš„ <code>((__block_impl *)blockDemo)</code> è¯´æ˜è¦æ‰§è¡Œ <code>FuncPtr</code> å‡½æ•°ï¼Œå¹¶æŠŠ <code>blockDemo</code> å¼ºè½¬ä¸º (<code>__block_impl * )</code> ä½œä¸ºå‚æ•°ä¼ é€’åˆ°è¯¥å‡½æ•°ä¸­</li>
</ol>
<h3 id="å°ç»“äºŒ"><a href="#å°ç»“äºŒ" class="headerlink" title="å°ç»“äºŒ"></a>å°ç»“äºŒ</h3><p>ä»ä¸Šé¢çš„å®è·µä¸­,æˆ‘ä»¬å¯ä»¥å¾—çŸ¥å¹³æ—¶åˆ›å»ºçš„ <code>Block</code> åŒ…å«äº† <code>struct __block_impl</code> å’Œç±»ä¼¼ <code>struct __main_block_desc_0</code> è¿™ä¸ <code>Blockå®ç°</code> ä¸­æè¿°çš„ <code>Block</code> çš„ç»“æ„æ˜¯ç­‰ä»·çš„ã€‚</p>
<h3 id="å…³äºé—®é¢˜ä¸€"><a href="#å…³äºé—®é¢˜ä¸€" class="headerlink" title="å…³äºé—®é¢˜ä¸€"></a>å…³äºé—®é¢˜ä¸€</h3><ul>
<li>åœ¨å®è·µä¸€ä¸­ç”¨ <code>po</code> è¾“å‡º <code>Block</code> çš„ <code>isa</code> å¯¹è±¡ä¸ºç±»ä¼¼ <code>__NSStackBlock__</code> è¿™ç§çš„ç±»å‹çš„</li>
<li>åœ¨å®è·µäºŒä¸­ç”¨ <code>clang</code> é‡å†™ <code>OC</code> ä»£ç ï¼Œ<code>Block</code> çš„ <code>isa</code> æŒ‡é’ˆæŒ‡å‘ <code>_NSConcreteStackBlock / _NSConcreteStackBlock</code></li>
</ul>
<p>å“ªä¸ªæ‰æ˜¯æ­£ç¡®çš„å‘¢?</p>
<p>æ€è€ƒä¹‹åï¼Œæˆ‘è§‰å¾—æ˜¯è¿™æ ·çš„:</p>
<p>ä»å†…å­˜è§’åº¦ä¸Šçœ‹ï¼Œ<code>isa</code> ä¸­ä¿å­˜çš„å°±æ˜¯ä¸€ä¸ªå†…å­˜åœ°å€ã€‚æˆ‘ä»¬ç”¨ <code>po</code> æ¥è¾“å‡ºæ—¶ï¼Œå°±æ˜¯å‘Šè¯‰ <code>lldb</code> æŠŠæˆ‘ä¼ å…¥çš„è¿™ä¸ªå†…å­˜åœ°å€è®¤ä¸ºæ˜¯ä¸€ä¸ªå¯¹è±¡çš„èµ·å§‹åœ°å€ï¼Œä»¥ä¸€ä¸ªå¯¹è±¡çš„è§’åº¦å»çœ‹å®ƒï¼Œå› ä¸º <code>Apple</code> å¯¹ <code>Block</code> è¿›è¡Œäº†ç›¸åº”çš„å°è£…ï¼Œè‡ªç„¶è¾“å‡ºå¯¹åº”çš„ <code>Block</code> å¯¹è±¡ç±»å‹ã€‚ç„¶ååœ¨ <code>clang</code> ç¿»è¯‘æˆ <code>C++</code> åï¼Œæ˜¯ä»¥ <code>_NSConcreteStackBlock</code> è¿™ç§å˜é‡åœ°å€çš„è§’åº¦æ¥çœ‹å¾…å®ƒã€‚ç®€è€Œè¨€ä¹‹ï¼Œä¸¤è€…éƒ½æ²¡æœ‰é—®é¢˜ï¼Œåªæ˜¯è§’åº¦ä¸åŒè€Œå·²ã€‚</p>
<h3 id="å®è·µä¸‰-æ•è·å¤–éƒ¨å˜é‡çš„-Block"><a href="#å®è·µä¸‰-æ•è·å¤–éƒ¨å˜é‡çš„-Block" class="headerlink" title="å®è·µä¸‰ : æ•è·å¤–éƒ¨å˜é‡çš„ Block"></a>å®è·µä¸‰ : æ•è·å¤–éƒ¨å˜é‡çš„ <code>Block</code></h3><p>ç±»ä¼¼å®è·µäºŒæ“ä½œï¼ŒæŸ¥çœ‹æ•è·äº†å¤–éƒ¨å˜é‡çš„ <code>Block</code> çš„å®ç°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="built_in">NSString</span> *testString;</span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> _a, <span class="built_in">NSString</span> *_testString, <span class="type">int</span> flags=<span class="number">0</span>) : a(_a), testString(_testString) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="type">int</span> a = __cself-&gt;a; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="built_in">NSString</span> *testString = __cself-&gt;testString; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_6832f1_mi_1,a,testString);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="type">void</span>*)&amp;dst-&gt;testString, (<span class="type">void</span>*)src-&gt;testString, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="type">void</span>*)src-&gt;testString, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="type">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="type">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSString</span> *testString = (<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_6832f1_mi_0;</span><br><span class="line">        <span class="type">void</span> (*blockDemo)() = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, a, testString, <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">        ((<span class="type">void</span> (*)(__block_impl *))((__block_impl *)blockDemo)-&gt;FuncPtr)((__block_impl *)blockDemo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> IMAGE_INFO &#123; <span class="type">unsigned</span> version; <span class="type">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“ä¸‰"><a href="#å°ç»“ä¸‰" class="headerlink" title="å°ç»“ä¸‰"></a>å°ç»“ä¸‰</h3><p><code>main</code> å‡½æ•°çš„æ‰§è¡Œæµç¨‹</p>
<p>è¿™æ¬¡ä¸å®è·µäºŒä¸»è¦å·®åˆ«åœ¨</p>
<ul>
<li>ç»“æ„ä½“ <code>__main_block_impl_0</code> çš„å¤šäº†ä¸¤ä¸ª <code>a</code> å’Œ <code>testString</code> å±æ€§æ¥æ”¶å¤–ç•Œä¼ å…¥çš„å‚æ•°ã€‚</li>
<li>ç»“æ„ä½“ <code>__main_block_desc_0</code> å¤šäº† <code>copy</code> å’Œ <code>dispose</code> ä¸¤ä¸ªå‡½æ•°</li>
<li>å¤šäº† <code>__main_block_copy_0</code> å’Œ <code>__main_block_dispose_0</code> ä¸¤ä¸ªé™æ€æ–¹æ³•</li>
</ul>
<p>æŸ¥çœ‹ <code>Block-private.h</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime support functions used by compiler when generating copy/dispose helpers</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Values for _Block_object_assign() and _Block_object_dispose() parameters</span></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">// see function implementation for a more complete description of these fields and combinations</span></span><br><span class="line">    BLOCK_FIELD_IS_OBJECT   =  <span class="number">3</span>,  <span class="comment">// id, NSObject, __attribute__((NSObject)), block, ...</span></span><br><span class="line">    BLOCK_FIELD_IS_BLOCK    =  <span class="number">7</span>,  <span class="comment">// a block variable</span></span><br><span class="line">    BLOCK_FIELD_IS_BYREF    =  <span class="number">8</span>,  <span class="comment">// the on stack structure holding the __block variable</span></span><br><span class="line">    BLOCK_FIELD_IS_WEAK     = <span class="number">16</span>,  <span class="comment">// declared __weak, only used in byref copy helpers</span></span><br><span class="line">    BLOCK_BYREF_CALLER      = <span class="number">128</span>, <span class="comment">// called from __block (byref) copy/dispose support routines.</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å› ä¸º <code>a</code> ä¸æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥æ˜¯ä»¥ä¼ å€¼çš„æ–¹å¼è¿›è¡Œä¼ é€’è¿‡ç¨‹ã€‚è€Œ <code>testString</code> æ˜¯å¯¹è±¡ï¼Œä¼šåœ¨å‡½æ•° <code>__main_block_copy_0</code> ä¸­ä»¥å‚æ•° <em>3</em> å»è°ƒç”¨å‡½æ•° <code>_Block_object_assign</code>ï¼Œåœ¨å‡½æ•° <code>__main_block_dispose_0</code> ä¸­ç±»ä¼¼ã€‚</p>
<h3 id="å®è·µå››-Block-ä¿®é¥°æ•è·çš„å˜é‡"><a href="#å®è·µå››-Block-ä¿®é¥°æ•è·çš„å˜é‡" class="headerlink" title="å®è·µå›› : __Block ä¿®é¥°æ•è·çš„å˜é‡"></a>å®è·µå›› : <code>__Block</code> ä¿®é¥°æ•è·çš„å˜é‡</h3><h4 id="æ’æ›²"><a href="#æ’æ›²" class="headerlink" title="æ’æ›²"></a>æ’æ›²</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// insert code here...</span></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSString</span> *testString = <span class="string">@&quot;2&quot;</span>;</span><br><span class="line">        __block <span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">        __block <span class="built_in">NSString</span> *testString2 = <span class="string">@&quot;3&quot;</span>;</span><br><span class="line">        <span class="type">void</span> (^blockDemo)() = ^() &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello world,%d,%d,%@,%@&quot;</span>,a,b,testString,testString2);</span><br><span class="line">        &#125;;</span><br><span class="line">        blockDemo();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç ç”¨ <code>clang -rewrite-objc</code> ä¼šæŠ¥ <code>clang: error: unable to execute command: Segmentation fault: 11</code> ï¼Œæ®µé”™è¯¯ï¼Œä¸€èˆ¬æ˜¯è®¿é—®äº†éæ³•åœ°å€é€ æˆçš„ã€‚å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸ºäº†é¿å…å­—ç¬¦ä¸²è¢«é‡å¤åˆ›å»ºï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ä¸ªå­—ç¬¦ä¸²å¸¸é‡ç¼“å­˜æ± ã€‚è€Œ <code>OC</code> ä¸­ä¹Ÿä¸ä¾‹å¤–ï¼Œç”¨å­—é¢é‡åˆ›å»ºçš„å­—ç¬¦ä¸²æ˜¯æ”¾åœ¨æ•°æ®æ®µä¸­çš„ã€‚</p>
<blockquote>
<p>the string will be stored in a area of memory called data segment. This area never changes after the application is launched</p>
</blockquote>
<p>è¿™ä¸ªåŒºåŸŸçš„æ•°æ®åœ¨åº”ç”¨å¯åŠ¨åä¸ä¼šè¢«æ”¹å˜ï¼Œè€Œç”¨ <code>__block</code> æ¥ä¿®é¥°ï¼Œå¾ˆæ˜æ˜¾æ˜¯æƒ³åœ¨ <code>block</code> ä¸­è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥æ‰ä¼šæŠ¥æ®µé”™è¯¯ã€‚</p>
<h4 id="å›å½’"><a href="#å›å½’" class="headerlink" title="å›å½’"></a>å›å½’</h4><p>ä¿®æ”¹åçš„ä»£ç </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// insert code here...</span></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSString</span> *testString = <span class="string">@&quot;2&quot;</span>;</span><br><span class="line">        __block <span class="type">int</span> b = <span class="number">2</span>;</span><br><span class="line">        __block <span class="built_in">NSString</span> *testString2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@&quot;3&quot;</span>];</span><br><span class="line">        <span class="type">void</span> (^blockDemo)() = ^() &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello world,%d,%d,%@,%@&quot;</span>,a,b,testString,testString2);</span><br><span class="line">        &#125;;</span><br><span class="line">        blockDemo();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>rewrite</code> åçš„ç»“æœ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_b_0 &#123;</span><br><span class="line">  <span class="type">void</span> *__isa;</span><br><span class="line">__Block_byref_b_0 *__forwarding;</span><br><span class="line"> <span class="type">int</span> __flags;</span><br><span class="line"> <span class="type">int</span> __size;</span><br><span class="line"> <span class="type">int</span> b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> __Block_byref_testString2_1 &#123;</span><br><span class="line">  <span class="type">void</span> *__isa;</span><br><span class="line">__Block_byref_testString2_1 *__forwarding;</span><br><span class="line"> <span class="type">int</span> __flags;</span><br><span class="line"> <span class="type">int</span> __size;</span><br><span class="line"> <span class="type">void</span> (*__Block_byref_id_object_copy)(<span class="type">void</span>*, <span class="type">void</span>*);</span><br><span class="line"> <span class="type">void</span> (*__Block_byref_id_object_dispose)(<span class="type">void</span>*);</span><br><span class="line"> <span class="built_in">NSString</span> *testString2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="built_in">NSString</span> *testString;</span><br><span class="line">  __Block_byref_b_0 *b; <span class="comment">// by ref</span></span><br><span class="line">  __Block_byref_testString2_1 *testString2; <span class="comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> _a, <span class="built_in">NSString</span> *_testString, __Block_byref_b_0 *_b, __Block_byref_testString2_1 *_testString2, <span class="type">int</span> flags=<span class="number">0</span>) : a(_a), testString(_testString), b(_b-&gt;__forwarding), testString2(_testString2-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_b_0 *b = __cself-&gt;b; <span class="comment">// bound by ref</span></span><br><span class="line">  __Block_byref_testString2_1 *testString2 = __cself-&gt;testString2; <span class="comment">// bound by ref</span></span><br><span class="line">  <span class="type">int</span> a = __cself-&gt;a; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="built_in">NSString</span> *testString = __cself-&gt;testString; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_894ba5_mi_2,a,(b-&gt;__forwarding-&gt;b),testString,(testString2-&gt;__forwarding-&gt;testString2));</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="type">void</span>*)&amp;dst-&gt;b, (<span class="type">void</span>*)src-&gt;b, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);_Block_object_assign((<span class="type">void</span>*)&amp;dst-&gt;testString, (<span class="type">void</span>*)src-&gt;testString, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);_Block_object_assign((<span class="type">void</span>*)&amp;dst-&gt;testString2, (<span class="type">void</span>*)src-&gt;testString2, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="type">void</span>*)src-&gt;b, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);_Block_object_dispose((<span class="type">void</span>*)src-&gt;testString, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);_Block_object_dispose((<span class="type">void</span>*)src-&gt;testString2, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="type">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="type">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSString</span> *testString = (<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_894ba5_mi_0;</span><br><span class="line">        __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_b_0 b = &#123;(<span class="type">void</span>*)<span class="number">0</span>,(__Block_byref_b_0 *)&amp;b, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_b_0), <span class="number">2</span>&#125;;</span><br><span class="line">        __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_testString2_1 testString2 = &#123;(<span class="type">void</span>*)<span class="number">0</span>,(__Block_byref_testString2_1 *)&amp;testString2, <span class="number">33554432</span>, <span class="keyword">sizeof</span>(__Block_byref_testString2_1), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131, ((<span class="built_in">NSString</span> *(*)(<span class="type">id</span>, SEL, <span class="built_in">NSString</span> *))(<span class="type">void</span> *)objc_msgSend)((<span class="type">id</span>)((<span class="built_in">NSString</span> *(*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *)objc_msgSend)((<span class="type">id</span>)objc_getClass(<span class="string">&quot;NSString&quot;</span>), sel_registerName(<span class="string">&quot;alloc&quot;</span>)), sel_registerName(<span class="string">&quot;initWithString:&quot;</span>), (<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_lk_znn1qp4925j412wt4t_qkplc0000gn_T_main_894ba5_mi_1)&#125;;</span><br><span class="line">        <span class="type">void</span> (*blockDemo)() = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, a, testString, (__Block_byref_b_0 *)&amp;b, (__Block_byref_testString2_1 *)&amp;testString2, <span class="number">570425344</span>));</span><br><span class="line">        ((<span class="type">void</span> (*)(__block_impl *))((__block_impl *)blockDemo)-&gt;FuncPtr)((__block_impl *)blockDemo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> IMAGE_INFO &#123; <span class="type">unsigned</span> version; <span class="type">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“å››"><a href="#å°ç»“å››" class="headerlink" title="å°ç»“å››"></a>å°ç»“å››</h3><p>ä»¥ <code>__block</code> ä¿®é¥°çš„å¤–éƒ¨å˜é‡è¢« <code>Block</code> æ•è·æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»¥ <code>__Block_byref_å˜é‡å_æ•è·é¡ºåº</code><br>ä¸ºå˜é‡åçš„ç»“æ„ä½“</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_b_0 b = &#123;(<span class="type">void</span>*)<span class="number">0</span>,(__Block_byref_b_0 *)&amp;b, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_b_0), <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*blockDemo)() = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, a, testString, (__Block_byref_b_0 *)&amp;b, (__Block_byref_testString2_1 *)&amp;testString2, <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">__main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> _a, <span class="built_in">NSString</span> *_testString, __Block_byref_b_0 *_b, __Block_byref_testString2_1 *_testString2, <span class="type">int</span> flags=<span class="number">0</span>) : a(_a), testString(_testString), b(_b-&gt;__forwarding), testString2(_testString2-&gt;__forwarding) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä¸Šé¢çš„ä»£ç ,å¯ä»¥å¾—å‡ºç»“æ„ä½“ <code>__Block_byref_xxx_xx</code> ä¸­çš„ <code>__forwarding</code> å°±æ˜¯æŒ‡å‘è¿™ä¸ªç»“æ„ä½“çš„åœ°å€ï¼ŒåŒæ—¶åœ¨ç»“æ„ä½“çš„åˆå§‹åŒ–æ–¹æ³•ä¸­ä¼ é€’çš„æ˜¯å˜é‡åœ°å€çš„å¼•ç”¨ï¼Œå¹¶å°†è¿™ä¸ªå¼•ç”¨ä¼ é€’ç»™ç»“æ„ä½“ <code>__main_block_impl_0</code> ä¸­å¯¹åº”çš„å¤–éƒ¨å˜é‡ï¼Œå› æ­¤ç”¨ <code>__block</code> ä¿®é¥°çš„å¤–éƒ¨å˜é‡æ˜¯ä»¥ä¼ å€çš„æ–¹å¼è¢« <code>Block</code> æ•è·çš„ã€‚</p>
<p><code>OC</code> çš„å†…å­˜ç®¡ç†æ˜¯åŸºäºå¼•ç”¨è®¡æ•°çš„ï¼Œæ‹·è´åˆ° <code>Block</code> ä¸­çš„å¤–éƒ¨å˜é‡è¢«ç»“æ„ä½“ <code>__Block_byref_xxx_xx</code> çš„ <code>__forwarding</code> æ‰€å¼•ç”¨äº†ï¼Œå› æ­¤éœ€è¦è€ƒè™‘ç»´æŠ¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åï¼Œä»¥æˆ‘çš„è¯æ¥æ€»ç»“ä¸‹ <code>Block</code> å…·ä½“æ˜¯ä»€ä¹ˆ?</p>
<p><code>Block</code> æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œåˆå§‹åŒ–æ–¹æ³•ä¸­æ¥æ”¶æ•è·çš„å¤–éƒ¨å˜é‡ï¼Œå…¶ä¸­æœ‰ <code>__block</code> ä¿®é¥°åˆ™ä¼ å€ï¼Œæ²¡æœ‰åˆ™ä¼ å€¼ï¼Œ ç»“æ„ä½“ä¸­çš„ <code>FuncPtr</code> å±æ€§ä»¥å‡½æ•°æŒ‡é’ˆçš„å½¢å¼æŒ‡å‘ä¸€ä¸ªé¢„å®šä¹‰çš„åŒ¿åå‡½æ•°ï¼Œåœ¨è°ƒç”¨æ—¶ï¼Œä¼šæŠŠ <code>Block</code> ä½œä¸ºå‚æ•°ä¼ é€’åˆ°é¢„å®šä¹‰çš„åŒ¿åå‡½æ•°ä¸­å¹¶æ‰§è¡Œã€‚</p>
<p><code>That&#39;s all</code></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/Block-ABI-Apple.html">Block Implementation Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Application_binary_interface">Wiki - Application binary interface</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/">è°ˆObjective-C blockçš„å®ç°</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nst/iOS-Runtime-Headers/">iOS-Runtime-Headers</a></li>
<li><a target="_blank" rel="noopener" href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/">a-look-inside-blocks-episode-3-block-copy</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/11249591/how-objective-c-handles-the-memory-of-immutable-strings">How Objective-C handles the memory of immutable strings </a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ObjC/" rel="tag"># ObjC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/03/21/Technology-Analysis-of-Https-protocol/" rel="prev" title="HTTPSåè®®">
      <i class="fa fa-chevron-left"></i> HTTPSåè®®
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/03/28/iOSer-Readers-iOS-App-signature-principle/" rel="next" title="iOS - Appç­¾åçš„åŸç†">
      iOS - Appç­¾åçš„åŸç† <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">2.</span> <span class="nav-text">ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-Block-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">å…³äº Block çš„å®ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E4%B8%80-%E6%96%B0%E5%BB%BA-Xcode-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">å®è·µä¸€ : æ–°å»º Xcode å‘½ä»¤è¡Œå·¥ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93%E4%B8%80"><span class="nav-number">4.2.</span> <span class="nav-text">å°ç»“ä¸€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80"><span class="nav-number">4.3.</span> <span class="nav-text">é—®é¢˜ä¸€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E4%BA%8C-clang-%E9%87%8D%E5%86%99%E5%B7%A5%E7%A8%8B%E7%9A%84-main-m-%E6%96%87%E4%BB%B6"><span class="nav-number">4.4.</span> <span class="nav-text">å®è·µäºŒ : clang é‡å†™å·¥ç¨‹çš„ main.m æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93%E4%BA%8C"><span class="nav-number">4.5.</span> <span class="nav-text">å°ç»“äºŒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E9%97%AE%E9%A2%98%E4%B8%80"><span class="nav-number">4.6.</span> <span class="nav-text">å…³äºé—®é¢˜ä¸€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E4%B8%89-%E6%8D%95%E8%8E%B7%E5%A4%96%E9%83%A8%E5%8F%98%E9%87%8F%E7%9A%84-Block"><span class="nav-number">4.7.</span> <span class="nav-text">å®è·µä¸‰ : æ•è·å¤–éƒ¨å˜é‡çš„ Block</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93%E4%B8%89"><span class="nav-number">4.8.</span> <span class="nav-text">å°ç»“ä¸‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E5%9B%9B-Block-%E4%BF%AE%E9%A5%B0%E6%8D%95%E8%8E%B7%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">4.9.</span> <span class="nav-text">å®è·µå›› : __Block ä¿®é¥°æ•è·çš„å˜é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E6%9B%B2"><span class="nav-number">4.9.1.</span> <span class="nav-text">æ’æ›²</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E5%BD%92"><span class="nav-number">4.9.2.</span> <span class="nav-text">å›å½’</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93%E5%9B%9B"><span class="nav-number">4.10.</span> <span class="nav-text">å°ç»“å››</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">å¿˜å·ä¸‰</p>
  <div class="site-description" itemprop="description">404~ ~ ~å°±å¤šèµ°ä¸€æ­¥</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¿˜å·ä¸‰</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
